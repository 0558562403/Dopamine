#import <Foundation/Foundation.h>
#import "xpc/xpc.h"

xpc_connection_t getJBDConnection(void)
{
	xpc_connection_t xpcConnection = xpc_connection_create_mach_service("com.opa334.jailbreakd", NULL, XPC_CONNECTION_MACH_SERVICE_PRIVILEGED);
	xpc_connection_set_event_handler(xpcConnection, ^(xpc_object_t object){});
	xpc_connection_resume(xpcConnection);

	return xpcConnection;
}

void sendPPLHandoffRequest(uint64_t magicPage)
{
	xpc_connection_t jdbConnection = getJBDConnection();

    xpc_object_t message = xpc_dictionary_create(NULL,NULL,0);
	xpc_dictionary_set_string(message, "action", "ppl-init");
	xpc_dictionary_set_uint64(message, "magicPage", magicPage);

    xpc_object_t reply = xpc_connection_send_message_with_reply_sync(jdbConnection, message);
	NSLog(@"reply = %s", xpc_copy_description(reply));
}

uint64_t sendPACHandoffRequest(uint64_t kernelAllocation)
{
	xpc_connection_t jdbConnection = getJBDConnection();

	xpc_object_t message = xpc_dictionary_create(NULL,NULL,0);
	xpc_dictionary_set_string(message, "action", "pac-init");
	xpc_dictionary_set_uint64(message, "kernelAllocation", kernelAllocation);

    xpc_object_t reply = xpc_connection_send_message_with_reply_sync(jdbConnection, message);
	NSLog(@"reply = %s", xpc_copy_description(reply));
	
	return xpc_dictionary_get_uint64(reply, "arcContext");
}

void sendPACFinalizeHandoffRequest(void)
{
	xpc_connection_t jdbConnection = getJBDConnection();

	xpc_object_t message = xpc_dictionary_create(NULL,NULL,0);
	xpc_dictionary_set_string(message, "action", "pac-finalize");

	xpc_object_t reply = xpc_connection_send_message_with_reply_sync(jdbConnection, message);
	NSLog(@"reply = %s", xpc_copy_description(reply));
}

void sendRebuildTrustCacheRequest(void)
{
	xpc_connection_t jdbConnection = getJBDConnection();

	xpc_object_t message = xpc_dictionary_create(NULL,NULL,0);
	xpc_dictionary_set_string(message, "action", "rebuild-trustcache");

	xpc_object_t reply = xpc_connection_send_message_with_reply_sync(jdbConnection, message);
	NSLog(@"reply = %s", xpc_copy_description(reply));
}